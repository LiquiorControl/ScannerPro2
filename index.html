<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner v4.5 - History View</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root { 
            --theme-font: 'Outfit', sans-serif; 
            --neon-cyan: #06b6d4;
            --neon-purple: #8b5cf6;
            --neon-pink: #ec4899;
            --neon-green: #10b981;
            --neon-blue: #3b82f6;
            --bg-dark: #050505;
        }
        
        body { 
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 0%, #1a103c, #000000 60%);
            background-attachment: fixed;
            color: #e2e8f0; 
            font-family: var(--theme-font), system-ui; 
            min-height: 100vh; 
            overscroll-behavior-y: none; 
            -webkit-font-smoothing: antialiased; 
        }

        /* PRO / EDGE STYLES */
        .glass {
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-left: 1px solid rgba(6, 182, 212, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(6, 182, 212, 0.1);
        }

        .glass-strong {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.15), inset 0 0 20px rgba(139, 92, 246, 0.05);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.6) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2) !important;
            color: white !important;
            backdrop-filter: blur(4px);
            transition: all 0.3s ease;
        }

        .glass-input:focus {
            border-bottom: 2px solid var(--neon-cyan) !important;
            box-shadow: 0 10px 25px -5px rgba(6, 182, 212, 0.3);
            background: rgba(6, 182, 212, 0.05) !important;
        }
        
        button:active { transform: scale(0.97); }
        input, select { font-size: 16px !important; }
        
        .animate-in { animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        #reader { 
            border-radius: 1.5rem !important; 
            overflow: hidden; 
            width: 100% !important; 
            border: 2px solid var(--neon-cyan) !important; 
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.4);
        }
        #reader video { object-fit: cover; border-radius: 1.5rem; }
        
        .menu-backdrop { position: fixed; inset: 0; z-index: 40; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); }

        .text-neon-cyan { color: var(--neon-cyan); text-shadow: 0 0 10px rgba(6,182,212,0.5); }
        .text-neon-purple { color: var(--neon-purple); text-shadow: 0 0 10px rgba(139,92,246,0.5); }
        .text-neon-blue { color: var(--neon-blue); text-shadow: 0 0 10px rgba(59,130,246,0.5); }
        .border-neon-cyan { border-color: var(--neon-cyan); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        window.fb = { initializeApp, getFirestore, doc, onSnapshot, setDoc, getAuth, signInAnonymously, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ETEKCITY BLUETOOTH CONFIG ---
        const SCALE_SERVICE_UUID = 0xFFF0; 
        const SCALE_CHAR_UUID    = 0xFFF1; 

        // ‚úÖ TUS CREDENCIALES
        const FIREBASE_CONFIG = { 
            apiKey: "AIzaSyDqdJcKILp5kQ4sTxVm8Ch5E7oXfMD3BAM",
            authDomain: "master-control-palmas.firebaseapp.com",
            projectId: "master-control-palmas",
            storageBucket: "master-control-palmas.firebasestorage.app",
            messagingSenderId: "681752784684",
            appId: "1:681752784684:web:e4a4a4ce96d587380d4689"
        };

        const ZONES_CONFIG = {
            bar1: [ { id: 'bar1_cooler', label: 'Cooler Beer', icon: 'üßä' }, { id: 'bar1_small_cooler_1', label: 'Small 1', icon: '‚ùÑÔ∏è' }, { id: 'bar1_small_cooler_2', label: 'Small 2', icon: '‚ùÑÔ∏è' }, { id: 'bar1_reaching', label: 'Reaching', icon: '‚úã' }, { id: 'bar1_shelf_full', label: 'Shelf Full', icon: 'üçæ' }, { id: 'bar1_shelf_open', label: 'Shelf Open', icon: 'ü•É' }, { id: 'bar1_well_1', label: 'Well 1', icon: 'ü•É' }, { id: 'bar1_well_2', label: 'Well 2', icon: 'ü•É' } ],
            bar2: [ { id: 'bar2_cooler', label: 'Cooler', icon: 'üßä' }, { id: 'bar2_small_cooler', label: 'Small Cooler', icon: '‚ùÑÔ∏è' } ],
            bodega: [ { id: 'bodega_closet', label: 'Closet', icon: 'üö™' }, { id: 'bodega_shelves', label: 'Shelves', icon: 'üóÑÔ∏è' } ]
        };

        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext; if (!AudioContext) return;
                const ctx = new AudioContext(); const osc = ctx.createOscillator(); const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination); const now = ctx.currentTime;
                if (type === 'success') { osc.type = "sine"; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(1600, now + 0.1); gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.4); osc.start(now); osc.stop(now + 0.4); }
                if (type === 'error') { osc.type = "sawtooth"; osc.frequency.setValueAtTime(120, now); osc.frequency.linearRampToValueAtTime(80, now + 0.3); gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3); osc.start(now); osc.stop(now + 0.3); }
                if (type === 'add') { osc.type = "triangle"; osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(900, now + 0.1); gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15); osc.start(now); osc.stop(now + 0.15); }
                if (type === 'sub') { osc.type = "square"; osc.frequency.setValueAtTime(250, now); osc.frequency.exponentialRampToValueAtTime(150, now + 0.15); gain.gain.setValueAtTime(0.15, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2); osc.start(now); osc.stop(now + 0.2); }
                if (type === 'blip') { osc.type = "sine"; osc.frequency.setValueAtTime(1000, now); osc.frequency.exponentialRampToValueAtTime(1000, now + 0.05); gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05); osc.start(now); osc.stop(now + 0.05); }
                if (type === 'connect') { osc.type = "sine"; osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(800, now + 0.2); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.4); osc.start(now); osc.stop(now + 0.4); }
            } catch (e) {}
        };

        const IconWrapper = ({ children, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Icons = {
            Scan: (p) => <IconWrapper {...p}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><rect width="10" height="6" x="7" y="9" rx="1"/></IconWrapper>,
            Search: (p) => <IconWrapper {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconWrapper>,
            MapPin: (p) => <IconWrapper {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconWrapper>,
            Beer: (p) => <IconWrapper {...p}><path d="M17 11h1a3 3 0 0 1 0 6h-1"/><path d="M9 12h6"/><path d="M9 12v3a8 8 0 0 1-16 0v-3"/><path d="M22 6h-7a2 2 0 0 0-2 2v2"/><path d="M5 12V3a2 2 0 0 1 2-2h7"/></IconWrapper>,
            Box: (p) => <IconWrapper {...p}><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></IconWrapper>,
            Wine: (p) => <IconWrapper {...p}><path d="M8 22h8"/><path d="M7 10h10"/><path d="M12 15v7"/><path d="M12 15a5 5 0 0 0 5-5c0-2-.5-4-2-8H9c-1.5 4-2 6-2 8a5 5 0 0 0 5 5Z"/></IconWrapper>,
            ChevronDown: (p) => <IconWrapper {...p}><path d="m6 9 6 6 6-6"/></IconWrapper>,
            List: (p) => <IconWrapper {...p}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></IconWrapper>,
            Link: (p) => <IconWrapper {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></IconWrapper>,
            Save: (p) => <IconWrapper {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>,
            Star: (p) => <IconWrapper {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconWrapper>,
            Package: (p) => <IconWrapper {...p}><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></IconWrapper>,
            Barcode: (p) => <IconWrapper {...p}><path d="M3 5v14"/><path d="M8 5v14"/><path d="M12 5v14"/><path d="M17 5v14"/><path d="M21 5v14"/></IconWrapper>,
            ShoppingCart: (p) => <IconWrapper {...p}><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></IconWrapper>,
            Settings: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/></IconWrapper>,
            Scale: (p) => <IconWrapper {...p}><rect x="4" y="4" width="16" height="16" rx="2"/><circle cx="12" cy="12" r="3"/><path d="M12 9v3"/></IconWrapper>,
            Wrench: (p) => <IconWrapper {...p}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></IconWrapper>,
            Refresh: (p) => <IconWrapper {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 21H3v-5"/></IconWrapper>,
            Reset: (p) => <IconWrapper {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconWrapper>,
            Upload: (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconWrapper>,
            Bluetooth: (p) => <IconWrapper {...p}><path d="m7 7 10 10-5 5V2l5 5L7 17"/></IconWrapper>
        };
        const LoginScreen = ({ onLogin }) => {
            const [pin, setPin] = useState("");
            const handlePress = (n) => {
                playSound('blip');
                const newP = pin + n;
                setPin(newP);
                if (newP === "1130") { playSound('success'); onLogin(); }
                if (newP.length >= 4 && newP !== "1130") { playSound('error'); setPin(""); }
            };
            return (
                <div className="fixed inset-0 flex flex-col items-center justify-center p-4 z-50 bg-[#000000]">
                    <div className="glass-strong w-full max-w-sm p-8 rounded-3xl border border-white/10 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-500 to-transparent"></div>
                        <div className="mb-8 text-center">
                            <h1 className="text-3xl font-black text-white tracking-tight drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">SCANNER <span className="text-cyan-400">PRO</span></h1>
                            <p className="text-cyan-500/70 text-sm mt-2 font-mono uppercase tracking-widest">Identify Yourself</p>
                        </div>
                        <div className="flex justify-center gap-4 mb-8">{[0,1,2,3].map(i=><div key={i} className={`w-3 h-3 rounded-sm border transform rotate-45 transition-all duration-300 ${pin.length>i?'bg-cyan-500 border-cyan-500 shadow-[0_0_15px_rgba(6,182,212,0.8)]':'border-gray-800 bg-black'}`}></div>)}</div>
                        <div className="grid grid-cols-3 gap-4">{[1,2,3,4,5,6,7,8,9,0].map(n=><button key={n} onClick={() => handlePress(n)} className={`h-20 w-20 rounded-2xl text-2xl font-bold text-white glass hover:border-cyan-500 hover:shadow-[0_0_15px_rgba(6,182,212,0.3)] active:scale-95 transition-all duration-200 ${n===0?'col-start-2':''}`}>{n}</button>)}</div>
                    </div>
                </div>
            );
        };

        const PurchasesLogModal = ({ onClose, data }) => {
            const purchasedItems = []; let totalPurchasedUnits = 0;
            data.forEach(cat => { cat.items.forEach(item => { const val = parseFloat(item.purchases); if (!isNaN(val) && val > 0) { purchasedItems.push({ ...item, categoryName: cat.category, purchaseVal: val }); totalPurchasedUnits += val; } }); });
            return (
                <div className="fixed inset-0 z-[80] flex flex-col backdrop-blur-xl bg-black/80 animate-in overflow-hidden">
                    <div className="p-4 border-b border-white/10 flex justify-between items-center bg-black/60 shadow-[0_4px_20px_rgba(0,0,0,0.5)]">
                        <h2 className="text-xl font-bold text-white flex items-center gap-2 text-neon-green"><Icons.Package /> Purchases Log</h2>
                        <button onClick={onClose} className="p-2 bg-white/5 hover:bg-white/10 text-white rounded-lg font-bold border border-white/10 backdrop-blur-md">Close</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4">
                        {purchasedItems.length === 0 ? <div className="text-center text-gray-500 mt-20 font-mono text-sm tracking-widest"><p>NO DATA LOGGED</p></div> : <div className="space-y-4"><div className="glass p-4 rounded-xl border-l-4 border-l-emerald-500"><div className="text-xs text-emerald-400 uppercase font-bold tracking-wider">Total Added Units</div><div className="text-4xl font-black text-white drop-shadow-[0_0_10px_rgba(16,185,129,0.5)]">{totalPurchasedUnits}</div></div><div className="grid gap-2">{purchasedItems.map((item, idx) => (<div key={idx} className="glass p-3 rounded-lg flex justify-between items-center hover:bg-white/5 transition-colors"><div><div className="font-bold text-white">{item.name}</div><div className="text-[10px] text-gray-500 font-mono uppercase">{item.categoryName}</div></div><div className="text-emerald-400 font-mono font-bold text-lg">+{item.purchaseVal}</div></div>))}</div></div>}
                    </div>
                </div>
            );
        };

        const PremiumControlModal = ({ onClose, data, onUpdateStickers }) => {
            const premiumCategory = data.find(cat => cat.category.includes("Premium"));
            const items = premiumCategory ? premiumCategory.items : [];
            const [searchTerm, setSearchTerm] = useState("");
            const [inputs, setInputs] = useState({});
            const handleInputChange = (itemId, val) => { setInputs(prev => ({ ...prev, [itemId]: val })); };
            const handleAddSticker = (item) => { const newSticker = inputs[item.id]; if (!newSticker || !newSticker.trim()) return; const currentStickers = item.sticker_ids || []; if (currentStickers.includes(newSticker.trim())) { playSound('error'); return; } const newArray = [...currentStickers, newSticker.trim()]; onUpdateStickers(item.id, newArray); setInputs(prev => ({ ...prev, [item.id]: "" })); playSound('add'); };
            const handleRemoveSticker = (item, stickerToRemove) => { const currentStickers = item.sticker_ids || []; const newArray = currentStickers.filter(s => s !== stickerToRemove); onUpdateStickers(item.id, newArray); playSound('sub'); };
            const filteredItems = items.filter(i => i.name.toLowerCase().includes(searchTerm.toLowerCase()));
            return (
                <div className="fixed inset-0 z-[90] flex flex-col backdrop-blur-xl bg-black/80 animate-in overflow-hidden">
                    <div className="p-4 border-b border-white/10 flex justify-between items-center bg-black/60"><div><h2 className="text-xl font-bold text-white flex items-center gap-2"><Icons.Star className="text-yellow-400 drop-shadow-[0_0_8px_rgba(250,204,21,0.6)]" /> Bottle Control</h2></div><button onClick={onClose} className="p-2 bg-white/5 text-white rounded-lg font-bold border border-white/10 hover:bg-white/10">Close</button></div>
                    <div className="p-4 bg-black/40 border-b border-white/5"><div className="relative"><Icons.Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" size={18} /><input type="text" placeholder="Search premium bottle..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full glass-input rounded-xl pl-10 pr-4 py-3 text-white focus:outline-none transition-all placeholder-gray-600" /></div></div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">{filteredItems.map(item => { const stickers = item.sticker_ids || []; return (<div key={item.id} className="glass rounded-xl p-4 border-l-2 border-l-yellow-500"><div className="flex justify-between items-start mb-3"><h3 className="font-bold text-white text-lg">{item.name}</h3><div className="bg-yellow-500/10 text-yellow-400 px-2 py-1 rounded text-xs font-bold border border-yellow-500/30 shadow-[0_0_10px_rgba(234,179,8,0.2)]">{stickers.length} in Stock</div></div><div className="flex gap-2 mb-4"><input type="number" placeholder="# Sticker" className="flex-1 glass-input rounded-lg px-3 py-2 text-white font-mono outline-none" value={inputs[item.id] || ""} onChange={(e) => handleInputChange(item.id, e.target.value)} /><button onClick={() => handleAddSticker(item)} className="bg-yellow-600/20 hover:bg-yellow-500/40 text-yellow-400 border border-yellow-500/50 px-4 py-2 rounded-lg font-bold text-sm shadow-[0_0_15px_rgba(234,179,8,0.1)] active:scale-95 transition-all backdrop-blur-sm">+ Add</button></div><div className="flex flex-wrap gap-2">{stickers.length === 0 && <span className="text-xs text-gray-600 italic">No tags loaded.</span>}{stickers.map((sticker, idx) => (<button key={idx} onClick={() => handleRemoveSticker(item, sticker)} className="group flex items-center gap-2 bg-black/40 hover:bg-red-900/30 border border-white/10 hover:border-red-500/50 px-3 py-1.5 rounded-lg transition-all animate-in"><Icons.Barcode size={14} className="text-gray-500 group-hover:text-red-400" /><span className="font-mono font-bold text-gray-300 group-hover:text-red-300">{sticker}</span><span className="text-[10px] text-red-500 opacity-0 group-hover:opacity-100 font-bold ml-1">X</span></button>))}</div></div>); })}</div>
                </div>
            );
        };

        const LinkModal = ({ barcode, data, onLink, onClose }) => {
            const [search, setSearch] = useState("");
            const filtered = data.map(c => ({ ...c, items: c.items.filter(i => i.name.toLowerCase().includes(search.toLowerCase())) })).filter(c => c.items.length > 0);
            return (
                <div className="fixed inset-0 z-50 flex flex-col animate-in backdrop-blur-xl bg-black/90">
                    <div className="p-4 bg-black/80 border-b border-red-500/30 flex flex-col gap-2 shadow-[0_0_30px_rgba(239,68,68,0.2)]"><div className="flex justify-between items-center"><h2 className="text-xl font-bold text-red-500 flex items-center gap-2 drop-shadow-[0_0_8px_rgba(239,68,68,0.6)]"><Icons.Link /> Unknown Code</h2><button onClick={onClose} className="text-gray-400 font-bold px-3 py-1 bg-white/5 rounded-lg hover:bg-white/10">Cancel</button></div><div className="bg-red-900/10 border border-red-500/50 p-2 rounded-lg text-center font-mono text-red-400 font-bold backdrop-blur-sm tracking-widest">{barcode}</div><p className="text-gray-500 text-sm text-center">Select product to link this code:</p></div>
                    <div className="p-4 bg-black/60 border-b border-white/5"><input type="text" placeholder="Search product name..." className="w-full glass-input rounded-xl py-3 px-4 text-white outline-none placeholder-gray-600" value={search} onChange={e=>setSearch(e.target.value)} autoFocus /></div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">{filtered.map(cat => (<div key={cat.category}><h3 className="text-cyan-500 font-bold text-xs uppercase mb-2 ml-2 tracking-widest drop-shadow-[0_0_5px_rgba(6,182,212,0.5)]">{cat.category}</h3>{cat.items.map(item => (<button key={item.id} onClick={() => onLink(item)} className="w-full text-left glass p-4 rounded-xl mb-2 flex justify-between items-center active:bg-white/10 transition-all hover:border-cyan-500/50"><span className="font-bold text-white">{item.name}</span><span className="text-xs text-gray-500">Link ‚Üí</span></button>))}</div>))}</div>
                </div>
            );
        };

        const ReviewModal = ({ onClose, data, onUpdate }) => {
            const mainLocs = [ { id: 'bar1', label: 'Bar 1', color: 'text-cyan-400', border: 'border-cyan-500' }, { id: 'bar2', label: 'Bar 2', color: 'text-purple-400', border: 'border-purple-500' }, { id: 'bodega', label: 'Storage', color: 'text-amber-400', border: 'border-amber-500' }, { id: 'barroluco', label: 'Barroluco', color: 'text-pink-400', border: 'border-pink-500' } ];
            return (
                <div className="fixed inset-0 z-50 flex flex-col animate-in backdrop-blur-xl bg-black/90">
                    <div className="p-4 bg-black/80 border-b border-white/10 flex justify-between items-center shrink-0 shadow-[0_4px_20px_rgba(0,0,0,0.8)]"><h2 className="text-xl font-bold text-white flex items-center gap-2"><Icons.List className="text-neon-cyan" /> Count Check</h2><button onClick={onClose} className="bg-white/5 hover:bg-white/10 text-white px-4 py-2 rounded-xl font-bold border border-white/10 backdrop-blur-md transition-all">Close</button></div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-8">
                        {mainLocs.map(main => {
                            const subZones = ZONES_CONFIG[main.id] || [];
                            const mainTotal = data.reduce((acc, cat) => acc + cat.items.reduce((iAcc, item) => iAcc + (parseFloat(item[main.id])||0), 0), 0);
                            const directItems = data.flatMap(cat => cat.items.filter(i => (parseFloat(i[main.id])||0) > 0)).map(i => ({...i, val: parseFloat(i[main.id])}));
                            if (mainTotal === 0) return null;
                            return (
                                <div key={main.id} className="space-y-3 relative">
                                    <div className={`sticky top-0 z-10 glass-strong py-3 px-4 rounded-xl mb-4 flex justify-between items-center border-l-4 ${main.border}`}><h3 className={`font-black text-lg uppercase tracking-widest drop-shadow-[0_0_8px_rgba(255,255,255,0.3)] ${main.color}`}>{main.label}</h3><span className="text-white font-mono text-sm font-bold bg-black/50 px-3 py-1 rounded border border-white/10 shadow-inner">Total: {mainTotal}</span></div>
                                    {subZones.map(zone => { 
                                        const zoneItems = data.flatMap(cat => cat.items.filter(i => (parseFloat(i[zone.id])||0) > 0)).map(i => ({...i, val: parseFloat(i[zone.id])})); 
                                        if (zoneItems.length === 0) return null; 
                                        return (
                                            <div key={zone.id} className="pl-2 border-l border-white/5 ml-1 relative">
                                                <div className="absolute left-[-1px] top-0 bottom-0 w-[1px] bg-gradient-to-b from-white/20 to-transparent"></div>
                                                <div className="text-xs font-bold text-gray-400 mb-2 flex items-center gap-2 pl-2 uppercase tracking-wider">{zone.icon} {zone.label}</div>
                                                <div className="grid gap-2">
                                                    {zoneItems.map(item => {
                                                        const isMulti = (zone.id === 'bar1_cooler' && (item.name.toLowerCase().includes('corona') || item.name.toLowerCase().includes('modelo')));
                                                        return (
                                                            <div key={item.id} className={`glass p-3 rounded-xl hover:bg-white/5 transition-colors ${isMulti ? 'flex flex-col gap-2' : 'flex justify-between items-center'}`}>
                                                                {isMulti ? (
                                                                    <>
                                                                        <div className="flex justify-between items-center w-full"><span className="font-medium text-white text-sm truncate">{item.name}</span><span className="text-cyan-400 font-mono font-bold text-lg bg-black/40 px-2 rounded border border-cyan-500/20">{item.val}</span></div>
                                                                        <div className="grid grid-cols-4 gap-2 w-full">{(item.breakdown_bar1_cooler || [0,0,0,0]).map((slotVal, idx) => (<div key={idx} className="relative"><div className="absolute -top-1.5 left-1/2 -translate-x-1/2 text-[8px] text-gray-500 font-bold bg-black px-1 rounded">S{idx+1}</div><input type="number" className="w-full bg-black/50 border border-white/10 rounded-lg text-center text-white font-mono text-sm py-2 focus:border-cyan-500 focus:shadow-[0_0_10px_rgba(6,182,212,0.2)] outline-none" value={slotVal || 0} onChange={(e) => { const newVal = parseFloat(e.target.value) || 0; const currentSlots = item.breakdown_bar1_cooler || [0,0,0,0]; const newSlots = [...currentSlots]; newSlots[idx] = newVal; const newZoneTotal = newSlots.reduce((a,b)=>a+b,0); let newMainTotal = newZoneTotal; subZones.forEach(z => { if(z.id !== zone.id) newMainTotal += (parseFloat(item[z.id])||0); }); onUpdate(item.id, { [zone.id]: newZoneTotal, [main.id]: newMainTotal, breakdown_bar1_cooler: newSlots }); }} /></div>))}</div>
                                                                    </>
                                                                ) : (
                                                                    <>
                                                                        <span className="font-medium text-white text-sm truncate pr-2">{item.name}</span>
                                                                        <input type="number" value={item.val} onChange={(e) => { const val = parseFloat(e.target.value) || 0; let newTotal = val; subZones.forEach(z => { if(z.id !== zone.id) newTotal += (parseFloat(item[z.id])||0); }); onUpdate(item.id, { [zone.id]: val, [main.id]: newTotal }); }} className="w-16 glass-input rounded px-2 py-1 text-right text-white font-mono font-bold focus:border-cyan-500 outline-none text-lg"/>
                                                                    </>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        ); 
                                    })} 
                                    {!subZones.length && directItems.map(item => (<div key={item.id} className="glass p-3 rounded-xl flex justify-between items-center"><span className="font-medium text-white text-sm truncate pr-2">{item.name}</span><input type="number" value={item.val} onChange={(e) => onUpdate(item.id, main.id, parseFloat(e.target.value)||0)} className="w-16 glass-input rounded px-2 py-1 text-right text-white font-mono font-bold focus:border-cyan-500 outline-none"/></div>))}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const BottleCalibrationModal = ({ item, onClose, onSave }) => {
            const [full, setFull] = useState(item.weight_full || "");
            const [empty, setEmpty] = useState(item.weight_empty || "");
            return (
                <div className="fixed inset-0 z-[60] flex flex-col items-center justify-center p-4 animate-in backdrop-blur-xl bg-black/80">
                    <div className="glass-strong w-full max-w-sm rounded-2xl p-6 border border-white/10 shadow-[0_0_50px_rgba(0,0,0,0.8)] relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-indigo-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
                        <div className="flex justify-between items-center mb-8 relative z-10"><h2 className="text-xl font-bold text-white flex items-center gap-2"><Icons.Wrench className="text-indigo-400" /> Scale Setup</h2><button onClick={onClose} className="text-gray-500 font-bold hover:text-white transition-colors">Cancel</button></div>
                        <div className="text-center mb-8 relative z-10"><h3 className="text-2xl font-bold text-white mb-1 drop-shadow-md">{item.name}</h3><p className="text-xs text-indigo-400 uppercase tracking-widest font-bold">Define weights in GRAMS</p></div>
                        <div className="space-y-6 mb-8 relative z-10">
                            <div><label className="block text-xs font-bold text-gray-500 uppercase mb-2 ml-1">Full Bottle (Gross)</label><div className="flex items-center gap-2"><input type="number" placeholder="e.g. 1300" className="w-full glass-input rounded-xl px-4 py-4 text-white font-mono text-xl focus:border-indigo-500 outline-none shadow-inner" value={full} onChange={e=>setFull(e.target.value)} /><span className="text-gray-500 font-bold font-mono">g</span></div></div>
                            <div><label className="block text-xs font-bold text-gray-500 uppercase mb-2 ml-1">Empty Bottle (Tare)</label><div className="flex items-center gap-2"><input type="number" placeholder="e.g. 500" className="w-full glass-input rounded-xl px-4 py-4 text-white font-mono text-xl focus:border-indigo-500 outline-none shadow-inner" value={empty} onChange={e=>setEmpty(e.target.value)} /><span className="text-gray-500 font-bold font-mono">g</span></div></div>
                        </div>
                        <button onClick={() => { if(full && empty) onSave(item.id, full, empty); }} className="w-full bg-indigo-600/20 hover:bg-indigo-600/40 text-indigo-300 font-bold py-4 rounded-xl shadow-[0_0_20px_rgba(79,70,229,0.2)] active:scale-95 transition-all border border-indigo-500/50 relative z-10 uppercase tracking-wider backdrop-blur-md">SAVE CONFIG</button>
                    </div>
                </div>
            );
        };
       // --- QUICK EDIT MODAL (CON HISTORY POR ZONA & BLUETOOTH) ---
        const QuickEditModal = ({ 
            item, 
            onClose, 
            onContinue, 
            onUpdate, 
            initialLocation, 
            initialSubZone, 
            onOpenCalibration,
            scaleWeight,        // Prop recibida de App
            isScaleConnected,   // Prop recibida de App
            onConnectScale      // Funci√≥n recibida de App
        }) => {
            const [value, setValue] = useState(0);
            const [manualGrams, setManualGrams] = useState("");
            
            const zones = ZONES_CONFIG[initialLocation] || [];
            const subZoneId = initialSubZone || (zones[0]?.id);
            const subZoneLabel = zones.find(z=>z.id===subZoneId)?.label;
            
            // 1. Determinar Campo Actual y Campo Hist√≥rico Espec√≠fico
            const targetField = zones.length > 0 ? subZoneId : initialLocation;
            const historyKey = `last_${targetField}`; // ej: last_bar1_shelf_open
            const historyVal = item[historyKey] !== undefined ? item[historyKey] : '-';
            
            const isOpenZone = ['bar1_shelf_open', 'bar1_well_1', 'bar1_well_2'].includes(initialSubZone);
            const isSmallGroup = ['bar1_shelf_full', 'bar2_cooler', 'bar2_small_cooler', 'bodega_closet'].includes(initialSubZone) || initialLocation === 'barroluco';
            const isMultiCount = (subZoneId === 'bar1_cooler' && (item.name.toLowerCase().includes('corona') || item.name.toLowerCase().includes('modelo')));
            
            const [slots, setSlots] = useState(() => { if(isMultiCount && item.breakdown_bar1_cooler) return item.breakdown_bar1_cooler; return [0, 0, 0, 0]; });
            const [startVal] = useState(() => parseFloat(item[targetField]) || 0);

            useEffect(() => { if(!isMultiCount) setValue(parseFloat(item[targetField]) || 0); else { const sum = slots.reduce((a, b) => a + (parseFloat(b)||0), 0); setValue(sum); } }, [item, targetField, isMultiCount, slots]);

            // 2. Escucha activa de la balanza (Persistencia)
            useEffect(() => {
                // Si la balanza env√≠a un dato nuevo y es una zona de pesaje
                if (isOpenZone && scaleWeight !== null && scaleWeight !== undefined && scaleWeight !== "") {
                    setManualGrams(scaleWeight);
                    performCalculation(scaleWeight);
                }
            }, [scaleWeight]);

            const updateValue = (next) => { setValue(next); if (zones.length > 0) { let newTotal = 0; zones.forEach(z => { if (z.id === subZoneId) newTotal += next; else newTotal += (parseFloat(item[z.id]) || 0); }); onUpdate(item.id, { [subZoneId]: next, [initialLocation]: newTotal }); } else { onUpdate(item.id, initialLocation, next); } };
            const handleSlotChange = (idx, val) => { const newSlots = [...slots]; newSlots[idx] = val === "" ? 0 : parseFloat(val); setSlots(newSlots); const newSum = newSlots.reduce((a, b) => a + b, 0); setValue(newSum); let newTotal = 0; zones.forEach(z => { if (z.id === subZoneId) newTotal += newSum; else newTotal += (parseFloat(item[z.id]) || 0); }); onUpdate(item.id, { [subZoneId]: newSum, [initialLocation]: newTotal, breakdown_bar1_cooler: newSlots }); };
            const handleDelta = (delta) => { const next = Math.max(0, Math.round((value + delta) * 100) / 100); updateValue(next); if(delta>0) playSound('add'); else playSound('sub'); };
            
            const performCalculation = (gramsInput) => {
                const grams = parseFloat(gramsInput);
                if (isNaN(grams) && gramsInput !== "") return;
                if (gramsInput === "") return;
                const full = parseFloat(item.weight_full);
                const empty = parseFloat(item.weight_empty);
                if (!full || !empty) return; 
                const netLiquid = full - empty;
                const currentLiquid = grams - empty;
                let calculatedUnits = currentLiquid / netLiquid;
                if (calculatedUnits < 0) calculatedUnits = 0;
                const finalVal = Math.round(calculatedUnits * 100) / 100;
                updateValue(finalVal);
            };

            const handleManualInput = (val) => { setManualGrams(val); performCalculation(val); };

            const sessionDiff = Math.round((value - startVal) * 100) / 100; const diffSign = sessionDiff > 0 ? "+" : ""; const diffColor = sessionDiff > 0 ? "text-emerald-400 drop-shadow-[0_0_15px_rgba(52,211,153,0.8)]" : sessionDiff < 0 ? "text-red-500 drop-shadow-[0_0_15px_rgba(239,68,68,0.8)]" : "text-gray-600";

            return (
                <div className="fixed inset-0 z-50 flex flex-col items-center justify-center p-2 animate-in backdrop-blur-xl bg-black/90"><div className="glass-strong w-full max-w-md rounded-3xl overflow-hidden flex flex-col h-[90vh] shadow-[0_0_50px_rgba(0,0,0,0.8)] border border-white/5 relative"><div className="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-cyan-500 via-purple-500 to-pink-500 opacity-50"></div><div className="p-5 bg-black/40 border-b border-white/5 flex justify-between items-center"><div><h2 className="text-2xl font-black text-white leading-none tracking-tight">{item.name}</h2><div className="text-xs text-cyan-400 font-mono mt-1 uppercase tracking-widest">{initialLocation} {subZoneLabel ? `> ${subZoneLabel}` : ''}</div></div><button onClick={onClose} className="bg-white/5 hover:bg-white/10 text-white p-3 rounded-xl font-bold backdrop-blur-md transition-all active:scale-90">‚úï</button></div><div className="flex-1 flex flex-col items-center justify-center relative overflow-hidden">
                    <div className="absolute inset-0 bg-gradient-to-b from-transparent via-cyan-900/5 to-transparent pointer-events-none"></div>
                    
                    <div className={`text-[9rem] font-black font-mono tracking-tighter leading-none mb-4 transition-all duration-200 select-none ${diffColor}`}>{diffSign}{sessionDiff}</div>
                    
                    {/* --- TOTAL + HISTORY POR ZONA --- */}
                    <div className="flex items-center gap-4 mb-6">
                        {/* Current */}
                        <div className="text-xl font-mono font-bold text-gray-400 bg-black/60 px-6 py-3 rounded-2xl border border-white/10 backdrop-blur-md shadow-lg flex flex-col items-center min-w-[100px]">
                            <span className="text-[10px] uppercase tracking-widest text-cyan-500 mb-1">Now</span>
                            <span className="text-white drop-shadow-[0_0_5px_rgba(255,255,255,0.5)] text-3xl">{value}</span>
                        </div>
                        
                        {/* History Zone Specific */}
                        <div className="text-xl font-mono font-bold text-gray-500 bg-white/5 px-6 py-3 rounded-2xl border border-white/5 backdrop-blur-md flex flex-col items-center min-w-[100px]">
                            <span className="text-[10px] uppercase tracking-widest text-gray-600 mb-1">Last</span>
                            <span className="text-gray-300 text-3xl">{historyVal}</span>
                        </div>
                    </div>

                    {isMultiCount ? (
                        <div className="w-full px-6 max-w-sm relative z-10">
                            <div className="text-center text-xs text-cyan-500/70 font-bold mb-4 uppercase tracking-[0.2em]">Multi-Count Slots</div>
                            <div className="grid grid-cols-2 gap-4">{slots.map((sVal, idx) => (<div key={idx} className="relative group"><div className="absolute top-2 left-3 text-[10px] text-cyan-500 font-bold group-hover:text-white transition-colors z-10">SLOT {idx+1}</div><input type="number" className="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-4 pt-7 text-white font-mono text-3xl text-center focus:border-cyan-500 focus:bg-cyan-900/10 focus:shadow-[0_0_20px_rgba(6,182,212,0.2)] outline-none transition-all" value={sVal || ""} placeholder="0" onChange={(e) => handleSlotChange(idx, e.target.value)} /></div>))}</div>
                        </div>
                    ) : (
                        <>
                            {/* --- Weight Calc Input --- */}
                            {isOpenZone && (
                                <div className="w-full px-6 max-w-sm relative z-10 mb-6 animate-in">
                                    {(!item.weight_full || !item.weight_empty) ? (
                                        <button onClick={() => onOpenCalibration(item)} className="w-full py-4 bg-yellow-500/10 border border-yellow-500/50 rounded-xl text-yellow-400 font-bold flex items-center justify-center gap-2 hover:bg-yellow-500/20 transition-all shadow-[0_0_15px_rgba(234,179,8,0.2)] backdrop-blur-sm animate-pulse"><Icons.Wrench /> ‚ö†Ô∏è SETUP WEIGHTS</button>
                                    ) : (
                                        <div className="flex flex-col gap-3">
                                            <div className="flex justify-between items-end px-1">
                                                <span className="text-xs text-cyan-500 font-bold uppercase tracking-widest">Weight Calc</span>
                                                <button onClick={onConnectScale} disabled={isScaleConnected} className={`text-[10px] font-bold px-3 py-1 rounded-full border transition-all flex items-center gap-1 uppercase tracking-wider ${isScaleConnected ? 'bg-blue-500/20 text-blue-400 border-blue-500/50 shadow-[0_0_10px_rgba(59,130,246,0.3)] cursor-default' : 'bg-white/5 text-gray-400 border-white/10 hover:bg-white/10 hover:text-white'}`}><Icons.Bluetooth className="w-3 h-3" /> {isScaleConnected ? "Connected" : "Connect Scale"}</button>
                                            </div>
                                            <div className="relative w-full group">
                                                <div className={`absolute inset-0 bg-gradient-to-r from-cyan-500/20 to-blue-500/20 rounded-xl blur transition-opacity duration-500 ${manualGrams ? 'opacity-100' : 'opacity-0'}`}></div>
                                                <input type="number" placeholder="0" className={`relative w-full bg-black/60 border rounded-xl px-4 py-3 text-white font-mono text-center text-3xl outline-none transition-all placeholder-gray-700 ${isScaleConnected ? 'border-blue-500/50 shadow-[0_0_15px_rgba(59,130,246,0.2)]' : 'border-white/20 focus:border-cyan-500 focus:shadow-[0_0_15px_rgba(6,182,212,0.3)]'}`} value={manualGrams} onChange={e=>handleManualInput(e.target.value)} />
                                                <div className="absolute right-4 top-5 text-gray-500 text-xs font-bold pointer-events-none">g</div>
                                                {manualGrams && <div className="absolute left-4 top-5 text-cyan-500 text-[10px] font-bold pointer-events-none animate-pulse">AUTO</div>}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* --- +/- Buttons --- */}
                            <div className="grid grid-cols-2 gap-5 w-full px-6 max-w-sm mb-5 relative z-10">
                                <div className="flex flex-col gap-3 items-end">
                                    {isSmallGroup ? (
                                        <>
                                            <button onClick={()=>handleDelta(-12)} className="w-full h-12 bg-red-950/30 hover:bg-red-900/50 text-red-400 border border-red-900/50 rounded-xl font-bold backdrop-blur-sm transition-all shadow-sm active:scale-95">- 12</button>
                                            <button onClick={()=>handleDelta(-6)} className="w-full h-12 bg-red-950/30 hover:bg-red-900/50 text-red-400 border border-red-900/50 rounded-xl font-bold backdrop-blur-sm transition-all shadow-sm active:scale-95">- 6</button>
                                            <button onClick={()=>handleDelta(-3)} className="w-full h-12 bg-red-950/30 hover:bg-red-900/50 text-red-400 border border-red-900/50 rounded-xl font-bold backdrop-blur-sm transition-all shadow-sm active:scale-95">- 3</button>
                                        </>
                                    ) : (
                                        <>
                                            {!isOpenZone && <button onClick={()=>handleDelta(-24)} className="w-full h-12 bg-red-950/30 hover:bg-red-900/50 text-red-400 border border-red-900/50 rounded-xl font-bold backdrop-blur-sm transition-all shadow-sm active:scale-95">- 24</button>}
                                            {!isOpenZone && <button onClick={()=>handleDelta(-12)} className="w-full h-12 bg-red-950/30 hover:bg-red-900/50 text-red-400 border border-red-900/50 rounded-xl font-bold backdrop-blur-sm transition-all shadow-sm active:scale-95">- 12</button>}
                                            {!isOpenZone && <button onClick={()=>handleDelta(-6)} className="w-full h-12 bg-red-950/30 hover:bg-red-900/50 text-red-400 border border-red-900/50 rounded-xl font-bold backdrop-blur-sm transition-all shadow-sm active:scale-95">- 6</button>}
                                        </>
                                    )}
                                    <button onClick={()=>handleDelta(-1)} className="w-full h-16 bg-red-600/10 hover:bg-red-600/30 text-red-500 rounded-2xl font-black text-3xl shadow-[0_0_20px_rgba(220,38,38,0.15)] border border-red-500/40 active:scale-95 transition-all">- 1</button>
                                </div>
                                <div className="flex flex-col gap-3 items-start">
                                    {isSmallGroup ? (
                                        <>
                                            <button onClick={()=>handleDelta(12)} className="w-full h-12 bg-emerald-950/30 hover:bg-emerald-900/50 text-emerald-400 border border-emerald-900/50 rounded-xl font-bold backdrop-blur-sm transition-all shadow-sm active:scale-95">+ 12</button>
                                            <button onClick={()=>handleDelta(6)} className="w-full h-12 bg-emerald-950/30 hover:bg-emerald-900/50 text-emerald-400 border border-emerald-900/50 rounded-xl font-bold backdrop-blur-sm transition-all shadow-sm active:scale-95">+ 6</button>
                                            <button onClick={()=>handleDelta(3)} className="w-full h-12 bg-emerald-950/30 hover:bg-emerald-900/50 text-emerald-400 border border-emerald-900/50 rounded-xl font-bold backdrop-blur-sm transition-all shadow-sm active:scale-95">+ 3</button>
                                        </>
                                    ) : (
                                        <>
                                            {!isOpenZone && <button onClick={()=>handleDelta(24)} className="w-full h-12 bg-emerald-950/30 hover:bg-emerald-900/50 text-emerald-400 border border-emerald-900/50 rounded-xl font-bold backdrop-blur-sm transition-all shadow-sm active:scale-95">+ 24</button>}
                                            {!isOpenZone && <button onClick={()=>handleDelta(12)} className="w-full h-12 bg-emerald-950/30 hover:bg-emerald-900/50 text-emerald-400 border border-emerald-900/50 rounded-xl font-bold backdrop-blur-sm transition-all shadow-sm active:scale-95">+ 12</button>}
                                            {!isOpenZone && <button onClick={()=>handleDelta(6)} className="w-full h-12 bg-emerald-950/30 hover:bg-emerald-900/50 text-emerald-400 border border-emerald-900/50 rounded-xl font-bold backdrop-blur-sm transition-all shadow-sm active:scale-95">+ 6</button>}
                                        </>
                                    )}
                                    <button onClick={()=>handleDelta(1)} className="w-full h-16 bg-emerald-600/10 hover:bg-emerald-600/30 text-emerald-400 rounded-2xl font-black text-3xl shadow-[0_0_20px_rgba(16,185,129,0.15)] border border-emerald-500/40 active:scale-95 transition-all">+ 1</button>
                                </div>
                            </div>
                            
                            {isOpenZone && (
                                <div className="grid grid-cols-2 gap-5 w-full px-6 max-w-sm relative z-10">
                                    <button onClick={()=>handleDelta(-0.1)} className="bg-white/5 hover:bg-white/10 text-red-400 h-12 rounded-xl font-bold text-lg border border-white/5 transition-all active:scale-95">- 0.1</button>
                                    <button onClick={()=>handleDelta(0.1)} className="bg-white/5 hover:bg-white/10 text-emerald-400 h-12 rounded-xl font-bold text-lg border border-white/5 transition-all active:scale-95">+ 0.1</button>
                                </div>
                            )}
                        </>
                    )}
                    
                    </div><button onClick={onContinue} className="m-5 bg-gradient-to-r from-indigo-900/80 to-purple-900/80 hover:from-indigo-800 hover:to-purple-800 text-white font-black text-xl h-16 rounded-2xl shadow-[0_0_30px_rgba(99,102,241,0.3)] active:scale-95 transition-all flex items-center justify-center gap-3 border border-white/10 relative z-20">DONE <span className="text-xs font-normal opacity-60 font-mono tracking-widest">(NEXT SCAN)</span></button></div></div>
            );
        };
        // --- COMPONENTES FINALES & APP ---

        const LocationModal = ({ onClose, onSelect }) => {
            const locs = [
                {id:'bar1',l:'Bar 1',i:Icons.Beer, c: 'text-cyan-400'},
                {id:'bar2',l:'Bar 2',i:Icons.Wine, c: 'text-purple-400'},
                {id:'bodega',l:'Bodega',i:Icons.Box, c: 'text-amber-400'},
                {id:'barroluco',l:'Barroluco',i:Icons.MapPin, c: 'text-pink-400'},
                {id:'purchases',l:'Purchases',i:Icons.ShoppingCart, c: 'text-emerald-400'}
            ];
            const [selMain, setSelMain] = useState(null);
            const subZones = selMain ? (ZONES_CONFIG[selMain] || []) : [];

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 animate-in backdrop-blur-xl bg-black/80">
                    <div className="glass-strong w-full max-w-lg rounded-3xl overflow-hidden flex flex-col max-h-[80vh] shadow-[0_0_50px_rgba(0,0,0,0.8)] border border-white/5">
                        <div className="p-5 border-b border-white/10 flex justify-between items-center bg-black/40"><h2 className="text-white font-bold tracking-widest uppercase text-sm">{selMain ? 'Select Zone' : 'Select Location'}</h2><button onClick={onClose} className="text-gray-500 font-bold hover:text-white transition-colors">CANCEL</button></div>
                        <div className="p-4 overflow-y-auto grid grid-cols-2 gap-4">
                            {!selMain ? locs.map(l=><button key={l.id} onClick={()=>{if(ZONES_CONFIG[l.id]) setSelMain(l.id); else onSelect(l.id, null);}} className="glass hover:bg-white/5 hover:border-white/20 text-white p-6 rounded-2xl flex flex-col items-center gap-3 transition-all active:scale-95 group border-transparent"><l.i className={`w-10 h-10 ${l.c} drop-shadow-[0_0_10px_rgba(255,255,255,0.2)] group-hover:scale-110 transition-transform`}/><span className="font-bold tracking-wider">{l.l}</span></button>) : 
                            subZones.map(z=><button key={z.id} onClick={()=>onSelect(selMain, z.id)} className="glass hover:bg-white/5 hover:border-white/20 text-white p-5 rounded-2xl flex flex-col items-center gap-3 transition-all active:scale-95 group border-transparent"><span className="text-3xl filter grayscale group-hover:grayscale-0 transition-all duration-300">{z.icon}</span><span className="font-medium text-sm text-gray-300 group-hover:text-white">{z.label}</span></button>)}
                            {selMain && subZones.length === 0 && (<div className="col-span-2 text-center text-gray-500 py-10">No sub-zones. <button onClick={()=>onSelect(selMain, null)} className="text-cyan-400 underline ml-2">Select Main</button></div>)}
                        </div>
                    </div>
                </div>
            );
        };

        const ScannerModal = ({ onScan, onClose }) => {
            useEffect(() => {
                const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: { width: 250, height: 250 } }, false);
                scanner.render(onScan, (e)=>{});
                return () => scanner.clear().catch(()=>{});
            }, []);
            return (
                <div className="fixed inset-0 bg-black z-40 flex flex-col">
                    <div className="p-4 bg-black/90 border-b border-cyan-500/20 flex justify-between items-center relative z-10 shadow-[0_0_20px_rgba(6,182,212,0.2)]">
                        <h2 className="text-cyan-400 font-bold tracking-widest flex items-center gap-2 animate-pulse"><div className="w-2 h-2 bg-cyan-500 rounded-full"></div> SCANNING ACTIVE</h2>
                        <button onClick={onClose} className="text-red-500 font-bold hover:text-red-400 transition-colors">ABORT</button>
                    </div>
                    <div className="flex-1 flex items-center justify-center p-4 bg-black relative">
                        <div className="absolute inset-0 opacity-10" style={{backgroundImage: 'linear-gradient(rgba(6, 182, 212, 0.5) 1px, transparent 1px), linear-gradient(90deg, rgba(6, 182, 212, 0.5) 1px, transparent 1px)', backgroundSize: '40px 40px'}}></div>
                        <div id="reader" className="w-full max-w-sm relative z-20"></div>
                    </div>
                </div>
            );
        };

        function App() {
            const [auth, setAuth] = useState(false);
            const [data, setData] = useState([]);
            const [loc, setLoc] = useState('bar1');
            const [subZone, setSubZone] = useState(null);
            const [scanning, setScanning] = useState(false);
            const [editItem, setEditItem] = useState(null);
            const [showLoc, setShowLoc] = useState(false);
            const [showMenu, setShowMenu] = useState(false);
            const [showCheck, setShowCheck] = useState(false);
            const [showPremium, setShowPremium] = useState(false);
            const [showPurchases, setShowPurchases] = useState(false);
            const [search, setSearch] = useState("");
            const [status, setStatus] = useState("Connecting...");
            const [pendingBarcode, setPendingBarcode] = useState(null);
            const [calibratingItem, setCalibratingItem] = useState(null);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            
            // Bluetooth Persistente
            const [scaleWeight, setScaleWeight] = useState("");
            const [isScaleConnected, setIsScaleConnected] = useState(false);

            useEffect(() => {
                const handleStatus = () => setIsOnline(navigator.onLine);
                window.addEventListener('online', handleStatus);
                window.addEventListener('offline', handleStatus);
                return () => { window.removeEventListener('online', handleStatus); window.removeEventListener('offline', handleStatus); };
            }, []);

            useEffect(() => {
                const app = window.fb.initializeApp(FIREBASE_CONFIG);
                const auth = window.fb.getAuth(app);
                const db = window.fb.getFirestore(app);
                window.fb.signInAnonymously(auth);
                window.fb.onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setStatus("Cloud Connected ‚òÅÔ∏è");
                        const path = typeof __app_id !== 'undefined' ? `artifacts/${__app_id}/public/data/inventory` : 'inventory';
                        window.fb.onSnapshot(window.fb.doc(db, path, 'master'), (s) => { if(s.exists()) setData(s.data().items); });
                    } else setStatus("Offline");
                });
            }, []);

            // BLUETOOTH GLOBAL
            const handleConnectScale = async () => {
                try {
                    const device = await navigator.bluetooth.requestDevice({ filters: [{ namePrefix: 'Etekcity' }], optionalServices: [0xFFF0] });
                    const server = await device.gatt.connect();
                    const service = await server.getPrimaryService(0xFFF0);
                    const characteristic = await service.getCharacteristic(0xFFF1);
                    await characteristic.startNotifications();
                    setIsScaleConnected(true);
                    playSound('connect');
                    characteristic.addEventListener('characteristicvaluechanged', (event) => {
                        const value = event.target.value;
                        if (value.byteLength < 12) return;
                        const weightRaw = value.getUint16(11, true); 
                        const finalWeight = (weightRaw / 10).toFixed(1); 
                        setScaleWeight(finalWeight);
                    });
                    device.addEventListener('gattserverdisconnected', () => { setIsScaleConnected(false); playSound('error'); });
                } catch (error) { console.error("Scale Error:", error); alert("Bluetooth Error: " + error.message); setIsScaleConnected(false); }
            };

            const handleUpdate = (id, fieldOrObj, val) => {
                const newData = data.map(cat => ({ ...cat, items: cat.items.map(i => { if(i.id === id) { if(typeof fieldOrObj === 'object') return {...i, ...fieldOrObj}; return {...i, [fieldOrObj]: val}; } return i; }) }));
                setData(newData);
                const db = window.fb.getFirestore();
                const path = typeof __app_id !== 'undefined' ? `artifacts/${__app_id}/public/data/inventory` : 'inventory';
                window.fb.setDoc(window.fb.doc(db, path, 'master'), { items: newData }).catch(console.error);
            };

            // --- RESET CON GUARDADO DE HISTORIAL POR ZONA ---
            const handleLocalReset = () => {
                if(!confirm("‚ö†Ô∏è START NEW WEEK?\n\nThis will reset active counts to 0 and save them as 'Last Count' for each zone.")) return;
                
                const resetData = data.map(cat => ({
                    ...cat,
                    items: cat.items.map(i => {
                        const resetItem = { ...i };
                        
                        // 1. Guardar Snapshot de cada sub-zona espec√≠fica
                        Object.values(ZONES_CONFIG).forEach(zoneArr => {
                            zoneArr.forEach(z => {
                                // Guarda "last_bar1_cooler" = valor actual de "bar1_cooler"
                                resetItem[`last_${z.id}`] = parseFloat(i[z.id]) || 0;
                                // Resetea a 0
                                resetItem[z.id] = 0;
                            });
                        });

                        // 2. Guardar Snapshot de zonas principales sueltas
                        ['bar1', 'bar2', 'bodega', 'barroluco', 'purchases'].forEach(k => {
                            resetItem[`last_${k}`] = parseFloat(i[k]) || 0;
                            resetItem[k] = 0;
                        });
                        
                        // NOTA: last_count general ya no es necesario si guardamos por zona, pero se puede dejar como backup.
                        return resetItem;
                    })
                }));
                
                setData(resetData);
                const db = window.fb.getFirestore();
                const path = typeof __app_id !== 'undefined' ? `artifacts/${__app_id}/public/data/inventory` : 'inventory';
                window.fb.setDoc(window.fb.doc(db, path, 'master'), { items: resetData }).catch(console.error);

                playSound('sub'); 
                setShowMenu(false);
            };

            const handleBackup = () => {
                const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a"); link.href = url; link.download = `Scanner_Backup_${new Date().toLocaleDateString().replace(/\//g,'-')}.json`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const handleScan = (txt) => {
                let found = null;
                for(const c of data) { const m = c.items.find(i => (i.barcode && i.barcode.includes(txt)) || (i.barcode_case && i.barcode_case === txt)); if(m){found=m; break;} }
                if(found) { setEditItem(found); setScanning(false); playSound('success'); } else { playSound('error'); setPendingBarcode(txt); setScanning(false); }
            };

            const handleLinkBarcode = (item) => {
                const currentCodes = item.barcode ? item.barcode : "";
                const newCodes = currentCodes ? `${currentCodes},${pendingBarcode}` : pendingBarcode;
                handleUpdate(item.id, 'barcode', newCodes);
                setPendingBarcode(null); setEditItem(item); playSound('success');
            };

            const updateItemStickers = (itemId, newStickersArray) => handleUpdate(itemId, 'sticker_ids', newStickersArray);
            const saveBottleWeights = (itemId, full, empty) => { handleUpdate(itemId, { weight_full: full, weight_empty: empty }); setCalibratingItem(null); playSound('success'); };

            const filteredData = useMemo(() => {
                const term = search.toLowerCase();
                return data.map(c => ({ ...c, items: c.items.filter(i => i.name.toLowerCase().includes(term)) })).filter(c => c.items.length > 0);
            }, [data, search]);

            if (!auth) return <LoginScreen onLogin={() => setAuth(true)} />;

            return (
                <div className="pb-40 pt-6 px-5 max-w-xl mx-auto relative min-h-screen">
                    <div className="flex justify-between items-end mb-8 relative z-20">
                        <div className="flex flex-col">
                             <h1 className="font-black text-3xl text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500 italic leading-none drop-shadow-[0_0_10px_rgba(6,182,212,0.5)]">SCANNER <span className="text-white">PRO</span></h1>
                             <div className="flex items-center gap-2 mt-1">
                                <span className="text-[10px] text-gray-500 font-mono tracking-widest uppercase">Sys.v4.5</span>
                                <div className={`w-2 h-2 rounded-full animate-pulse ${isOnline ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]' : 'bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.8)]'}`}></div>
                                {isScaleConnected && <div className="text-[10px] bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded border border-blue-500/50 flex items-center gap-1 shadow-[0_0_10px_rgba(59,130,246,0.4)]"><Icons.Bluetooth className="w-3 h-3"/> SCALE ON</div>}
                             </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <button onClick={() => setShowCheck(true)} className="glass text-white p-3 rounded-xl hover:bg-cyan-500/10 hover:border-cyan-500/50 active:scale-95 transition-all group hover:shadow-[0_0_15px_rgba(6,182,212,0.2)]"><Icons.List className="h-6 w-6 group-hover:text-cyan-400 transition-colors" /></button>
                            <button onClick={() => setShowMenu(!showMenu)} className="glass text-white p-3 rounded-xl hover:bg-purple-500/10 hover:border-purple-500/50 active:scale-95 transition-all group hover:shadow-[0_0_15px_rgba(168,85,247,0.2)]"><Icons.Settings className="group-hover:text-purple-400 transition-colors" /></button>
                        </div>
                        {showMenu && (
                            <>
                                <div className="menu-backdrop" onClick={() => setShowMenu(false)}></div>
                                <div className="absolute top-16 right-0 glass-strong p-2 rounded-2xl shadow-[0_0_30px_rgba(0,0,0,1)] z-50 flex flex-col gap-1 w-64 animate-in border border-white/10">
                                    <button onClick={() => { setShowPurchases(true); setShowMenu(false); }} className="flex items-center gap-3 p-4 hover:bg-white/5 rounded-xl text-gray-300 hover:text-white font-bold transition-all text-sm uppercase tracking-wide border border-transparent hover:border-white/10"><Icons.Package className="text-emerald-500" /> Purchases</button>
                                    <button onClick={() => { setShowPremium(true); setShowMenu(false); }} className="flex items-center gap-3 p-4 hover:bg-white/5 rounded-xl text-gray-300 hover:text-white font-bold transition-all text-sm uppercase tracking-wide border border-transparent hover:border-white/10"><Icons.Star className="text-yellow-500" /> Bottle Ctrl</button>
                                    <button onClick={() => { handleBackup(); setShowMenu(false); }} className="flex items-center gap-3 p-4 hover:bg-white/5 rounded-xl text-gray-300 hover:text-white font-bold transition-all text-sm uppercase tracking-wide border border-transparent hover:border-white/10"><Icons.Save className="text-indigo-500" /> Backup Data</button>
                                    <button onClick={handleLocalReset} className="flex items-center gap-3 p-4 hover:bg-red-500/10 hover:border hover:border-red-500/30 rounded-xl text-gray-300 hover:text-red-400 font-bold transition-all text-sm uppercase tracking-wide border border-transparent"><Icons.Refresh className="text-red-500" /> Local Reset</button>
                                </div>
                            </>
                        )}
                    </div>

                    <button onClick={() => setShowLoc(true)} className="w-full glass border border-white/10 p-5 rounded-2xl flex items-center justify-between mb-6 group active:scale-95 transition-all hover:border-cyan-500/30 hover:shadow-[0_0_20px_rgba(6,182,212,0.1)] relative overflow-hidden">
                        <div className="absolute top-0 bottom-0 left-0 w-1 bg-cyan-500"></div>
                        <div className="flex items-center gap-4">
                            <div className="bg-cyan-500/10 p-2.5 rounded-xl text-cyan-400 border border-cyan-500/20 group-hover:bg-cyan-500 group-hover:text-black transition-all duration-300"><Icons.MapPin /></div>
                            <div className="text-left">
                                <div className="text-[10px] text-gray-500 uppercase font-bold tracking-[0.2em] mb-1">Current Zone</div>
                                <div className="text-white font-black text-xl leading-none uppercase tracking-wide group-hover:text-cyan-400 transition-colors">
                                    {ZONES_CONFIG[loc] ? (ZONES_CONFIG[loc].find(z=>z.id===subZone)?.label || 'Select Zone') : loc === 'purchases' ? 'Purchases' : loc === 'barroluco' ? 'Barroluco' : 'Main Area'}
                                </div>
                            </div>
                        </div>
                        <Icons.ChevronDown className="text-gray-600 group-hover:text-white transition-colors"/>
                    </button>

                    <div className="relative mb-8 group">
                        <div className="absolute -inset-0.5 bg-gradient-to-r from-cyan-500 to-purple-600 rounded-2xl opacity-20 group-hover:opacity-40 transition duration-300 blur"></div>
                        <div className="relative"><Icons.Search className="absolute left-4 top-3.5 text-gray-500 group-focus-within:text-cyan-400 transition-colors" /><input type="text" placeholder="Search item manually..." className="w-full bg-black border border-white/10 rounded-xl py-3 pl-12 pr-4 text-white focus:border-cyan-500/50 outline-none transition-all placeholder-gray-600 focus:bg-white/5" value={search} onChange={e=>setSearch(e.target.value)} /></div>
                    </div>

                    {filteredData.map(cat => (
                        <div key={cat.category} className="mb-6">
                            <h3 className="text-purple-400 font-bold text-xs uppercase mb-3 ml-2 tracking-[0.2em] drop-shadow-[0_0_5px_rgba(168,85,247,0.4)]">{cat.category}</h3>
                            <div className="space-y-2">
                                {cat.items.map(item => {
                                    const qty = parseFloat(item[subZone || loc]) || 0;
                                    const hasQty = qty > 0;
                                    return (
                                        <div key={item.id} onClick={() => setEditItem(item)} className={`p-4 rounded-xl flex justify-between items-center cursor-pointer border transition-all duration-200 ${hasQty ? "glass bg-cyan-900/10 border-cyan-500/30 shadow-[0_0_15px_rgba(6,182,212,0.05)]" : "glass border-transparent hover:border-white/10 active:scale-[0.98]"}`}>
                                            <div className={`font-medium transition-colors ${hasQty ? 'text-white' : 'text-gray-400'}`}>{item.name}</div>
                                            {hasQty && <div className="bg-cyan-500 text-black font-black font-mono px-3 py-1 rounded shadow-[0_0_10px_rgba(6,182,212,0.6)] text-sm">{qty}</div>}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    ))}

                    <button onClick={() => setScanning(true)} className="fixed bottom-10 left-1/2 -translate-x-1/2 h-20 w-20 bg-black text-white rounded-full shadow-[0_0_40px_rgba(6,182,212,0.4)] flex items-center justify-center border-2 border-cyan-500 z-30 active:scale-90 transition-all group overflow-hidden">
                         <div className="absolute inset-0 bg-cyan-500 opacity-20 group-hover:opacity-40 animate-pulse"></div>
                        <Icons.Scan className="w-8 h-8 text-cyan-400 group-hover:text-white transition-colors relative z-10" />
                    </button>

                    {pendingBarcode && <LinkModal barcode={pendingBarcode} data={data} onLink={handleLinkBarcode} onClose={() => { setPendingBarcode(null); setTimeout(() => setScanning(true), 300); }} />}
                    {showPremium && <PremiumControlModal onClose={() => setShowPremium(false)} data={data} onUpdateStickers={updateItemStickers} />}
                    {showPurchases && <PurchasesLogModal onClose={() => setShowPurchases(false)} data={data} />}
                    {showCheck && <ReviewModal onClose={() => setShowCheck(false)} data={data} onUpdate={handleUpdate} />}
                    {showLoc && <LocationModal onClose={() => setShowLoc(false)} onSelect={(l, s) => { setLoc(l); setSubZone(s); setShowLoc(false); }} />}
                    {scanning && <ScannerModal onScan={handleScan} onClose={() => setScanning(false)} />}
                    {calibratingItem && <BottleCalibrationModal item={calibratingItem} onClose={()=>setCalibratingItem(null)} onSave={saveBottleWeights} />}
                    
                    {editItem && (
                        <QuickEditModal 
                            item={editItem} 
                            initialLocation={loc} 
                            initialSubZone={subZone} 
                            onClose={() => setEditItem(null)} 
                            onOpenCalibration={setCalibratingItem} 
                            onContinue={() => { setEditItem(null); setTimeout(() => setScanning(true), 300); }} 
                            onUpdate={handleUpdate}
                            scaleWeight={scaleWeight}
                            isScaleConnected={isScaleConnected}
                            onConnectScale={handleConnectScale}
                        />
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
