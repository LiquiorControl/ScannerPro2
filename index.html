<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner v28 - Fixed Label</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root { --theme-font: 'Outfit', sans-serif; }
        body { background: #000000; color: #f8fafc; font-family: var(--theme-font), system-ui; min-height: 100vh; overscroll-behavior-y: none; -webkit-font-smoothing: antialiased; }
        input, select { background-color: rgba(20,20,20,1) !important; border-color: #333 !important; color: white !important; font-size: 16px !important; }
        .animate-in { animation: slideUpFade 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        #reader { border-radius: 1.5rem !important; overflow: hidden; width: 100% !important; }
        #reader video { object-fit: cover; border-radius: 1.5rem; }
        .menu-backdrop { position: fixed; inset: 0; z-index: 40; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        window.fb = { initializeApp, getFirestore, doc, onSnapshot, setDoc, getAuth, signInAnonymously, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ‚úÖ TUS CREDENCIALES
        const FIREBASE_CONFIG = { 
            apiKey: "AIzaSyDqdJcKILp5kQ4sTxVm8Ch5E7oXfMD3BAM",
            authDomain: "master-control-palmas.firebaseapp.com",
            projectId: "master-control-palmas",
            storageBucket: "master-control-palmas.firebasestorage.app",
            messagingSenderId: "681752784684",
            appId: "1:681752784684:web:e4a4a4ce96d587380d4689"
        };

        const ZONES_CONFIG = {
            bar1: [ { id: 'bar1_cooler', label: 'Cooler Beer', icon: 'üßä' }, { id: 'bar1_small_cooler_1', label: 'Small 1', icon: '‚ùÑÔ∏è' }, { id: 'bar1_small_cooler_2', label: 'Small 2', icon: '‚ùÑÔ∏è' }, { id: 'bar1_reaching', label: 'Reaching', icon: '‚úã' }, { id: 'bar1_shelf_full', label: 'Shelf Full', icon: 'üçæ' }, { id: 'bar1_shelf_open', label: 'Shelf Open', icon: 'ü•É' }, { id: 'bar1_well_1', label: 'Well 1', icon: 'ü•É' }, { id: 'bar1_well_2', label: 'Well 2', icon: 'ü•É' } ],
            bar2: [ { id: 'bar2_cooler', label: 'Cooler', icon: 'üßä' }, { id: 'bar2_small_cooler', label: 'Small Cooler', icon: '‚ùÑÔ∏è' } ],
            bodega: [ { id: 'bodega_closet', label: 'Closet', icon: 'üö™' }, { id: 'bodega_shelves', label: 'Shelves', icon: 'üóÑÔ∏è' } ]
        };

        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext; if (!AudioContext) return;
                const ctx = new AudioContext(); const osc = ctx.createOscillator(); const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination); const now = ctx.currentTime;
                if (type === 'success') { osc.type = "sine"; osc.frequency.setValueAtTime(1000, now); osc.frequency.exponentialRampToValueAtTime(2000, now + 0.1); gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5); osc.start(now); osc.stop(now + 0.5); }
                if (type === 'error') { osc.type = "sawtooth"; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.3); gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3); osc.start(now); osc.stop(now + 0.3); }
                if (type === 'add') { osc.type = "sine"; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1); gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2); osc.start(now); osc.stop(now + 0.2); }
                if (type === 'sub') { osc.type = "square"; osc.frequency.setValueAtTime(300, now); osc.frequency.exponentialRampToValueAtTime(150, now + 0.15); gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.25); osc.start(now); osc.stop(now + 0.25); }
                if (type === 'blip') { osc.type = "sine"; osc.frequency.setValueAtTime(1200, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.05); gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05); osc.start(now); osc.stop(now + 0.05); }
            } catch (e) {}
        };

        const IconWrapper = ({ children, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Icons = {
            Scan: (p) => <IconWrapper {...p}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><rect width="10" height="6" x="7" y="9" rx="1"/></IconWrapper>,
            Search: (p) => <IconWrapper {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconWrapper>,
            MapPin: (p) => <IconWrapper {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconWrapper>,
            Beer: (p) => <IconWrapper {...p}><path d="M17 11h1a3 3 0 0 1 0 6h-1"/><path d="M9 12h6"/><path d="M9 12v3a8 8 0 0 1-16 0v-3"/><path d="M22 6h-7a2 2 0 0 0-2 2v2"/><path d="M5 12V3a2 2 0 0 1 2-2h7"/></IconWrapper>,
            Box: (p) => <IconWrapper {...p}><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></IconWrapper>,
            Wine: (p) => <IconWrapper {...p}><path d="M8 22h8"/><path d="M7 10h10"/><path d="M12 15v7"/><path d="M12 15a5 5 0 0 0 5-5c0-2-.5-4-2-8H9c-1.5 4-2 6-2 8a5 5 0 0 0 5 5Z"/></IconWrapper>,
            ChevronDown: (p) => <IconWrapper {...p}><path d="m6 9 6 6 6-6"/></IconWrapper>,
            List: (p) => <IconWrapper {...p}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></IconWrapper>,
            Link: (p) => <IconWrapper {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></IconWrapper>,
            Save: (p) => <IconWrapper {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>,
            Star: (p) => <IconWrapper {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconWrapper>,
            Package: (p) => <IconWrapper {...p}><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></IconWrapper>,
            Barcode: (p) => <IconWrapper {...p}><path d="M3 5v14"/><path d="M8 5v14"/><path d="M12 5v14"/><path d="M17 5v14"/><path d="M21 5v14"/></IconWrapper>,
            ShoppingCart: (p) => <IconWrapper {...p}><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></IconWrapper>,
            Settings: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/></IconWrapper>,
            Scale: (p) => <IconWrapper {...p}><rect x="4" y="4" width="16" height="16" rx="2"/><circle cx="12" cy="12" r="3"/><path d="M12 9v3"/></IconWrapper>,
            Wrench: (p) => <IconWrapper {...p}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></IconWrapper>
        };

        const LoginScreen = ({ onLogin }) => {
            const [pin, setPin] = useState("");
            return (
                <div className="fixed inset-0 bg-black flex flex-col items-center justify-center p-4 z-50">
                    <div className="mb-8 text-center"><h1 className="text-3xl font-black text-white tracking-tight">SCANNER</h1><p className="text-gray-500 text-sm">Authorized Personnel Only</p></div>
                    <div className="flex gap-4 mb-8">{[0,1,2,3].map(i=><div key={i} className={`w-4 h-4 rounded-full border ${pin.length>i?'bg-indigo-500 border-indigo-500':'border-gray-600'}`}></div>)}</div>
                    <div className="grid grid-cols-3 gap-6">{[1,2,3,4,5,6,7,8,9,0].map(n=><button key={n} onClick={()=>{const newP=pin+n;setPin(newP);if(newP==="1130") onLogin(); if(newP.length>=4 && newP!=="1130") setPin("");}} className={`h-20 w-20 rounded-full text-2xl font-bold text-white bg-gray-900 border border-gray-700 active:bg-indigo-600 ${n===0?'col-start-2':''}`}>{n}</button>)}</div>
                </div>
            );
        };

        const PurchasesLogModal = ({ onClose, data }) => {
            const purchasedItems = []; let totalPurchasedUnits = 0;
            data.forEach(cat => { cat.items.forEach(item => { const val = parseFloat(item.purchases); if (!isNaN(val) && val > 0) { purchasedItems.push({ ...item, categoryName: cat.category, purchaseVal: val }); totalPurchasedUnits += val; } }); });
            return (
                <div className="fixed inset-0 bg-black/90 flex flex-col z-[80] backdrop-blur-sm animate-in overflow-hidden">
                    <div className="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-900">
                        <h2 className="text-xl font-bold text-white flex items-center gap-2"><Icons.Package className="text-emerald-400" /> Purchases Log</h2>
                        <button onClick={onClose} className="p-2 bg-gray-800 text-gray-400 rounded-lg font-bold border border-gray-700">Close</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4">
                        {purchasedItems.length === 0 ? <div className="text-center text-gray-600 mt-20"><p className="text-lg">No purchases recorded.</p></div> : <div className="space-y-4"><div className="bg-gray-900 p-4 rounded-xl border border-gray-800"><div className="text-xs text-gray-500 uppercase font-bold tracking-wider">Total Added Units</div><div className="text-3xl font-black text-emerald-400">{totalPurchasedUnits}</div></div><div className="grid gap-2">{purchasedItems.map((item, idx) => (<div key={idx} className="bg-gray-900 p-3 rounded-lg border border-gray-800 flex justify-between items-center"><div><div className="font-bold text-white">{item.name}</div><div className="text-[10px] text-gray-500">{item.categoryName}</div></div><div className="text-emerald-400 font-mono font-bold text-lg">+{item.purchaseVal}</div></div>))}</div></div>}
                    </div>
                </div>
            );
        };

        const PremiumControlModal = ({ onClose, data, onUpdateStickers }) => {
            const premiumCategory = data.find(cat => cat.category.includes("Premium"));
            const items = premiumCategory ? premiumCategory.items : [];
            const [searchTerm, setSearchTerm] = useState("");
            const [inputs, setInputs] = useState({});
            const handleInputChange = (itemId, val) => { setInputs(prev => ({ ...prev, [itemId]: val })); };
            const handleAddSticker = (item) => { const newSticker = inputs[item.id]; if (!newSticker || !newSticker.trim()) return; const currentStickers = item.sticker_ids || []; if (currentStickers.includes(newSticker.trim())) { playSound('error'); return; } const newArray = [...currentStickers, newSticker.trim()]; onUpdateStickers(item.id, newArray); setInputs(prev => ({ ...prev, [item.id]: "" })); playSound('add'); };
            const handleRemoveSticker = (item, stickerToRemove) => { const currentStickers = item.sticker_ids || []; const newArray = currentStickers.filter(s => s !== stickerToRemove); onUpdateStickers(item.id, newArray); playSound('sub'); };
            const filteredItems = items.filter(i => i.name.toLowerCase().includes(searchTerm.toLowerCase()));
            return (
                <div className="fixed inset-0 bg-black/95 flex flex-col z-[90] backdrop-blur-md animate-in overflow-hidden">
                    <div className="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-900"><div><h2 className="text-xl font-bold text-white flex items-center gap-2"><Icons.Star className="text-yellow-500" /> Bottle Control</h2></div><button onClick={onClose} className="p-2 bg-gray-800 text-gray-400 rounded-lg font-bold border border-gray-700">Close</button></div>
                    <div className="p-4 bg-black border-b border-gray-800"><div className="relative"><Icons.Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" size={18} /><input type="text" placeholder="Search premium bottle..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full bg-gray-900 border border-gray-700 rounded-xl pl-10 pr-4 py-3 text-white focus:outline-none focus:border-yellow-500 transition-all" /></div></div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">{filteredItems.map(item => { const stickers = item.sticker_ids || []; return (<div key={item.id} className="bg-gray-900 border border-gray-800 rounded-xl p-4"><div className="flex justify-between items-start mb-3"><h3 className="font-bold text-white text-lg">{item.name}</h3><div className="bg-yellow-500/10 text-yellow-500 px-2 py-1 rounded text-xs font-bold border border-yellow-500/20">{stickers.length} in Stock</div></div><div className="flex gap-2 mb-4"><input type="number" placeholder="# Sticker" className="flex-1 bg-black border border-gray-700 rounded-lg px-3 py-2 text-white font-mono focus:border-yellow-500 outline-none" value={inputs[item.id] || ""} onChange={(e) => handleInputChange(item.id, e.target.value)} /><button onClick={() => handleAddSticker(item)} className="bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg active:scale-95 transition-all">+ Add</button></div><div className="flex flex-wrap gap-2">{stickers.length === 0 && <span className="text-xs text-gray-600 italic">No tags loaded.</span>}{stickers.map((sticker, idx) => (<button key={idx} onClick={() => handleRemoveSticker(item, sticker)} className="group flex items-center gap-2 bg-gray-800 hover:bg-red-900/30 border border-gray-700 hover:border-red-500/50 px-3 py-1.5 rounded-lg transition-all animate-in"><Icons.Barcode size={14} className="text-gray-500 group-hover:text-red-400" /><span className="font-mono font-bold text-white group-hover:text-red-300">{sticker}</span><span className="text-[10px] text-red-500 opacity-0 group-hover:opacity-100 font-bold ml-1">X</span></button>))}</div></div>); })}</div>
                </div>
            );
        };

        const LinkModal = ({ barcode, data, onLink, onClose }) => {
            const [search, setSearch] = useState("");
            const filtered = data.map(c => ({ ...c, items: c.items.filter(i => i.name.toLowerCase().includes(search.toLowerCase())) })).filter(c => c.items.length > 0);
            return (
                <div className="fixed inset-0 bg-black/95 z-50 flex flex-col animate-in">
                    <div className="p-4 bg-gray-900 border-b border-gray-800 flex flex-col gap-2"><div className="flex justify-between items-center"><h2 className="text-xl font-bold text-red-400 flex items-center gap-2"><Icons.Link /> Unknown Code</h2><button onClick={onClose} className="text-gray-400 font-bold px-3 py-1 bg-gray-800 rounded-lg">Cancel</button></div><div className="bg-red-900/20 border border-red-500/50 p-2 rounded-lg text-center font-mono text-red-200 font-bold">{barcode}</div><p className="text-gray-400 text-sm text-center">Select product to link this code:</p></div>
                    <div className="p-4 bg-black border-b border-gray-800"><input type="text" placeholder="Search product name..." className="w-full bg-gray-900 border border-gray-700 rounded-xl py-3 px-4 text-white focus:border-indigo-500 outline-none" value={search} onChange={e=>setSearch(e.target.value)} autoFocus /></div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">{filtered.map(cat => (<div key={cat.category}><h3 className="text-indigo-400 font-bold text-xs uppercase mb-2">{cat.category}</h3>{cat.items.map(item => (<button key={item.id} onClick={() => onLink(item)} className="w-full text-left bg-gray-900 border border-gray-800 p-4 rounded-xl mb-2 flex justify-between items-center active:bg-indigo-900 transition-colors"><span className="font-bold text-white">{item.name}</span><span className="text-xs text-gray-500">Link ‚Üí</span></button>))}</div>))}</div>
                </div>
            );
        };

        const ReviewModal = ({ onClose, data, onUpdate }) => {
            const mainLocs = [ { id: 'bar1', label: 'Bar 1', color: 'text-blue-400' }, { id: 'bar2', label: 'Bar 2', color: 'text-purple-400' }, { id: 'bodega', label: 'Storage', color: 'text-amber-400' }, { id: 'barroluco', label: 'Barroluco', color: 'text-rose-400' } ];
            return (
                <div className="fixed inset-0 bg-black/95 z-50 flex flex-col animate-in">
                    <div className="p-4 bg-gray-900 border-b border-gray-800 flex justify-between items-center shrink-0"><h2 className="text-xl font-bold text-white flex items-center gap-2"><Icons.List className="text-emerald-400" /> Count Check</h2><button onClick={onClose} className="bg-gray-800 text-white px-4 py-2 rounded-xl font-bold border border-gray-700">Close</button></div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-6">
                        {mainLocs.map(main => {
                            const subZones = ZONES_CONFIG[main.id] || [];
                            const mainTotal = data.reduce((acc, cat) => acc + cat.items.reduce((iAcc, item) => iAcc + (parseFloat(item[main.id])||0), 0), 0);
                            const directItems = data.flatMap(cat => cat.items.filter(i => (parseFloat(i[main.id])||0) > 0)).map(i => ({...i, val: parseFloat(i[main.id])}));
                            if (mainTotal === 0) return null;
                            return (
                                <div key={main.id} className="space-y-3"><div className="sticky top-0 z-10 bg-gray-900/90 backdrop-blur border-b border-gray-800 py-2"><h3 className={`font-black text-lg uppercase ${main.color}`}>{main.label} <span className="text-white text-sm opacity-50 ml-2">({mainTotal})</span></h3></div>{subZones.map(zone => { const zoneItems = data.flatMap(cat => cat.items.filter(i => (parseFloat(i[zone.id])||0) > 0)).map(i => ({...i, val: parseFloat(i[zone.id])})); if (zoneItems.length === 0) return null; return (<div key={zone.id} className="pl-2 border-l-2 border-gray-800 ml-1"><div className="text-sm font-bold text-gray-400 mb-2 flex items-center gap-2">{zone.icon} {zone.label}</div><div className="grid gap-2">{zoneItems.map(item => (<div key={item.id} className="bg-gray-900 p-3 rounded-xl border border-gray-800 flex justify-between items-center"><span className="font-medium text-white text-sm truncate pr-2">{item.name}</span><input type="number" value={item.val} onChange={(e) => { const val = parseFloat(e.target.value) || 0; let newTotal = val; subZones.forEach(z => { if(z.id !== zone.id) newTotal += (parseFloat(item[z.id])||0); }); onUpdate(item.id, { [zone.id]: val, [main.id]: newTotal }); }} className="w-16 bg-black border border-gray-700 rounded px-2 py-1 text-right text-white font-mono font-bold focus:border-emerald-500 outline-none"/></div>))}</div></div>); })} {!subZones.length && directItems.map(item => (<div key={item.id} className="bg-gray-900 p-3 rounded-xl border border-gray-800 flex justify-between items-center"><span className="font-medium text-white text-sm truncate pr-2">{item.name}</span><input type="number" value={item.val} onChange={(e) => onUpdate(item.id, main.id, parseFloat(e.target.value)||0)} className="w-16 bg-black border border-gray-700 rounded px-2 py-1 text-right text-white font-mono font-bold focus:border-emerald-500 outline-none"/></div>))}</div>
                            );
                        })}
                        {!data.some(c=>c.items.some(i=>parseFloat(i.bar1)||parseFloat(i.bar2)||parseFloat(i.bodega)||parseFloat(i.barroluco))) && <div className="text-center text-gray-600 mt-20">Nothing counted yet.</div>}
                    </div>
                </div>
            );
        };

        // --- BOTTLE WEIGHT CONFIG MODAL ---
        const BottleCalibrationModal = ({ item, onClose, onSave }) => {
            const [full, setFull] = useState(item.weight_full || "");
            const [empty, setEmpty] = useState(item.weight_empty || "");
            
            return (
                <div className="fixed inset-0 bg-black/95 z-[60] flex flex-col items-center justify-center p-4 animate-in">
                    <div className="w-full max-w-sm bg-gray-900 border border-gray-700 rounded-2xl p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-white">Scale Setup</h2>
                            <button onClick={onClose} className="text-gray-400 font-bold">Cancel</button>
                        </div>
                        <div className="text-center mb-6">
                            <h3 className="text-2xl font-bold text-indigo-400 mb-1">{item.name}</h3>
                            <p className="text-xs text-gray-500 uppercase">Define weights in GRAMS</p>
                        </div>
                        <div className="space-y-4 mb-6">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Full Bottle (Gross)</label>
                                <div className="flex items-center gap-2">
                                    <input type="number" placeholder="e.g. 1300" className="w-full bg-black border border-gray-700 rounded-lg px-3 py-3 text-white font-mono text-lg focus:border-indigo-500 outline-none" value={full} onChange={e=>setFull(e.target.value)} />
                                    <span className="text-gray-500 font-bold">g</span>
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Empty Bottle (Tare)</label>
                                <div className="flex items-center gap-2">
                                    <input type="number" placeholder="e.g. 500" className="w-full bg-black border border-gray-700 rounded-lg px-3 py-3 text-white font-mono text-lg focus:border-indigo-500 outline-none" value={empty} onChange={e=>setEmpty(e.target.value)} />
                                    <span className="text-gray-500 font-bold">g</span>
                                </div>
                            </div>
                        </div>
                        <button onClick={() => { if(full && empty) onSave(item.id, full, empty); }} className="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all">SAVE CONFIG</button>
                    </div>
                </div>
            );
        };

        // --- GLOBAL QUICK EDIT ---
        const QuickEditModal = ({ item, onClose, onContinue, onUpdate, initialLocation, initialSubZone, onOpenCalibration }) => {
            const [value, setValue] = useState(0);
            const zones = ZONES_CONFIG[initialLocation] || [];
            const subZoneId = initialSubZone || (zones[0]?.id);
            const subZoneLabel = zones.find(z=>z.id===subZoneId)?.label;
            const targetField = zones.length > 0 ? subZoneId : initialLocation;
            
            // Check if we are in "Shelf Open" to show manual weight features
            const isOpenZone = (initialSubZone === 'bar1_shelf_open');
            const [manualGrams, setManualGrams] = useState("");

            // Session tracking
            const [startVal] = useState(() => parseFloat(item[targetField]) || 0);

            useEffect(() => { setValue(parseFloat(item[targetField]) || 0); }, [item, targetField]);

            const updateValue = (next) => {
                setValue(next); 
                if (zones.length > 0) { 
                    let newTotal = 0; 
                    zones.forEach(z => { if (z.id === subZoneId) newTotal += next; else newTotal += (parseFloat(item[z.id]) || 0); }); 
                    onUpdate(item.id, { [subZoneId]: next, [initialLocation]: newTotal }); 
                } else { 
                    onUpdate(item.id, initialLocation, next); 
                }
            };

            const handleDelta = (delta) => {
                const next = Math.max(0, Math.round((value + delta) * 100) / 100);
                updateValue(next);
                if(delta>0) playSound('add'); else playSound('sub');
            };

            // Manual Weight Calculation
            const calculateFromManual = () => {
                const grams = parseFloat(manualGrams);
                if(!grams && grams !== 0) return;

                const full = parseFloat(item.weight_full);
                const empty = parseFloat(item.weight_empty);
                
                if (!full || !empty) {
                    onOpenCalibration(item); // Force Setup
                    return;
                }
                
                const netLiquid = full - empty;
                const currentLiquid = grams - empty;
                
                let calculatedUnits = currentLiquid / netLiquid;
                if (calculatedUnits < 0) calculatedUnits = 0;
                
                const finalVal = Math.round(calculatedUnits * 100) / 100;
                updateValue(finalVal);
                playSound('success');
                setManualGrams(""); // Clear input after use
            };

            const sessionDiff = Math.round((value - startVal) * 100) / 100;
            const diffSign = sessionDiff > 0 ? "+" : "";
            const diffColor = sessionDiff > 0 ? "text-emerald-400" : sessionDiff < 0 ? "text-red-400" : "text-gray-500";

            return (
                <div className="fixed inset-0 bg-black/95 flex flex-col items-center justify-center z-50 p-2 animate-in"><div className="w-full max-w-md bg-gray-900 rounded-3xl border border-gray-700 overflow-hidden flex flex-col h-[90vh]"><div className="p-4 bg-black border-b border-gray-800 flex justify-between items-center"><div><h2 className="text-2xl font-bold text-white leading-none">{item.name}</h2><div className="text-xs text-indigo-400 font-mono mt-1 uppercase">{initialLocation} {subZoneLabel ? `> ${subZoneLabel}` : ''}</div></div><button onClick={onClose} className="bg-gray-800 text-white p-3 rounded-xl font-bold">‚úï</button></div><div className="flex-1 flex flex-col items-center justify-center bg-gradient-to-b from-gray-900 to-black">
                    
                    {/* SESSION (BIG) */}
                    <div className={`text-[8rem] font-black font-mono tracking-tighter leading-none mb-2 ${diffColor}`}>
                        {diffSign}{sessionDiff}
                    </div>
                    {/* TOTAL (SMALL) */}
                    <div className="text-xl font-mono font-bold text-gray-500 mb-6 bg-gray-900/50 px-3 py-1 rounded-lg border border-gray-800">
                        Total Zone: <span className="text-white">{value}</span>
                    </div>

                    <div className="grid grid-cols-2 gap-4 w-full px-6 max-w-sm mb-4"><div className="flex flex-col gap-2 items-end"><button onClick={()=>handleDelta(-12)} className="w-full h-12 bg-red-900/20 text-red-500 border border-red-900/50 rounded-xl font-bold">- 12</button><button onClick={()=>handleDelta(-6)} className="w-full h-12 bg-red-900/20 text-red-500 border border-red-900/50 rounded-xl font-bold">- 6</button><button onClick={()=>handleDelta(-5)} className="w-full h-12 bg-red-900/20 text-red-500 border border-red-900/50 rounded-xl font-bold">- 5</button><button onClick={()=>handleDelta(-1)} className="w-full h-14 bg-red-600 text-white rounded-xl font-black text-2xl shadow-lg border border-red-400">- 1</button></div><div className="flex flex-col gap-2 items-start"><button onClick={()=>handleDelta(12)} className="w-full h-12 bg-emerald-900/20 text-emerald-500 border border-emerald-900/50 rounded-xl font-bold">+ 12</button><button onClick={()=>handleDelta(6)} className="w-full h-12 bg-emerald-900/20 text-emerald-500 border border-emerald-900/50 rounded-xl font-bold">+ 6</button><button onClick={()=>handleDelta(5)} className="w-full h-12 bg-emerald-900/20 text-emerald-500 border border-emerald-900/50 rounded-xl font-bold">+ 5</button><button onClick={()=>handleDelta(1)} className="w-full h-14 bg-emerald-600 text-white rounded-xl font-black text-2xl shadow-lg border border-emerald-400">+ 1</button></div></div><div className="grid grid-cols-2 gap-4 w-full px-6 max-w-sm"><button onClick={()=>handleDelta(-0.1)} className="bg-gray-800 text-red-400 h-12 rounded-xl font-bold text-lg border border-gray-700">- 0.1</button><button onClick={()=>handleDelta(0.1)} className="bg-gray-800 text-emerald-400 h-12 rounded-xl font-bold text-lg border border-gray-700">+ 0.1</button></div>
                
                    {/* --- MANUAL WEIGHT SECTION (ONLY FOR SHELF OPEN) --- */}
                    {isOpenZone && (
                        <div className="mt-6 w-full px-6 max-w-sm border-t border-gray-800 pt-4">
                            {(!item.weight_full || !item.weight_empty) ? (
                                <button onClick={() => onOpenCalibration(item)} className="w-full py-3 bg-yellow-900/30 border border-yellow-500/50 rounded-xl text-yellow-400 font-bold flex items-center justify-center gap-2 hover:bg-yellow-900/50 transition-colors animate-pulse">
                                    <Icons.Wrench /> ‚ö†Ô∏è SETUP WEIGHTS
                                </button>
                            ) : (
                                <div className="flex flex-col gap-2">
                                    <div className="flex justify-between items-center px-1">
                                        <span className="text-xs text-gray-500 font-bold uppercase">Weight Calc</span>
                                        <button onClick={() => onOpenCalibration(item)} className="text-xs text-indigo-400 font-bold underline flex items-center gap-1 hover:text-indigo-300">
                                            <Icons.Wrench size={12} /> Edit Setup
                                        </button>
                                    </div>
                                    <div className="flex gap-2">
                                        <div className="relative flex-1">
                                            <input type="number" placeholder="Enter Grams" className="w-full bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 text-white font-mono text-center focus:border-indigo-500 outline-none" value={manualGrams} onChange={e=>setManualGrams(e.target.value)} />
                                            <div className="absolute right-3 top-3 text-gray-500 text-xs font-bold">g</div>
                                        </div>
                                        <button onClick={calculateFromManual} className="bg-indigo-600 text-white px-6 rounded-xl font-bold text-sm shadow-lg active:scale-95 border border-indigo-500/50 flex items-center gap-2"><Icons.Scale className="w-4 h-4" /> CALC</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                    {/* ------------------------ */}

                    </div><button onClick={onContinue} className="m-4 bg-indigo-600 text-white font-black text-xl h-14 rounded-2xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">DONE <span className="text-xs font-normal opacity-70">(Next Scan)</span></button></div></div>
            );
        };

        const LocationModal = ({ onClose, onSelect }) => {
            const locs = [
                {id:'bar1',l:'Bar 1',i:Icons.Beer},
                {id:'bar2',l:'Bar 2',i:Icons.Wine},
                {id:'bodega',l:'Bodega',i:Icons.Box},
                {id:'barroluco',l:'Barroluco',i:Icons.MapPin},
                {id:'purchases',l:'Purchases',i:Icons.ShoppingCart}
            ];
            const [selMain, setSelMain] = useState(null);
            return (
                <div className="fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4">
                    <div className="w-full max-w-lg bg-gray-900 rounded-2xl border border-gray-700 overflow-hidden flex flex-col max-h-[80vh]">
                        <div className="p-4 border-b border-gray-800 flex justify-between items-center"><h2 className="text-white font-bold">{selMain ? 'Select Zone' : 'Select Location'}</h2><button onClick={onClose} className="text-gray-400 font-bold">Cancel</button></div>
                        <div className="p-4 overflow-y-auto grid grid-cols-2 gap-3">
                            {!selMain ? locs.map(l=><button key={l.id} onClick={()=>{if(ZONES_CONFIG[l.id]) setSelMain(l.id); else onSelect(l.id, null);}} className="bg-gray-800 hover:bg-indigo-600 text-white p-4 rounded-xl border border-gray-700 flex flex-col items-center gap-2 transition-all"><l.i className="w-8 h-8 opacity-50"/><span>{l.l}</span></button>) : 
                            ZONES_CONFIG[selMain].map(z=><button key={z.id} onClick={()=>onSelect(selMain, z.id)} className="bg-gray-800 hover:bg-emerald-600 text-white p-4 rounded-xl border border-gray-700 flex flex-col items-center gap-2 transition-all"><span className="text-2xl">{z.icon}</span><span>{z.label}</span></button>)}
                        </div>
                    </div>
                </div>
            );
        };

        const ScannerModal = ({ onScan, onClose }) => {
            useEffect(() => {
                const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: { width: 250, height: 250 } }, false);
                scanner.render(onScan, (e)=>{});
                return () => scanner.clear().catch(()=>{});
            }, []);
            return (
                <div className="fixed inset-0 bg-black z-40 flex flex-col"><div className="p-4 bg-gray-900 border-b border-gray-800 flex justify-between items-center"><h2 className="text-white font-bold">Scanning...</h2><button onClick={onClose} className="text-red-400 font-bold">Close</button></div><div className="flex-1 flex items-center justify-center p-4 bg-black"><div id="reader" className="w-full max-w-sm border-2 border-indigo-500 rounded-xl"></div></div></div>
            );
        };

        function App() {
            const [auth, setAuth] = useState(false);
            const [data, setData] = useState([]);
            const [loc, setLoc] = useState('bar1');
            const [subZone, setSubZone] = useState(null);
            const [scanning, setScanning] = useState(false);
            const [editItem, setEditItem] = useState(null);
            const [showLoc, setShowLoc] = useState(false);
            const [showMenu, setShowMenu] = useState(false);
            const [showCheck, setShowCheck] = useState(false);
            const [showPremium, setShowPremium] = useState(false);
            const [showPurchases, setShowPurchases] = useState(false);
            const [search, setSearch] = useState("");
            const [status, setStatus] = useState("Connecting...");
            const [pendingBarcode, setPendingBarcode] = useState(null);
            const [calibratingItem, setCalibratingItem] = useState(null);

            useEffect(() => {
                const app = window.fb.initializeApp(FIREBASE_CONFIG);
                const auth = window.fb.getAuth(app);
                const db = window.fb.getFirestore(app);
                window.fb.signInAnonymously(auth);
                window.fb.onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setStatus("Cloud Connected ‚òÅÔ∏è");
                        const path = typeof __app_id !== 'undefined' ? `artifacts/${__app_id}/public/data/inventory` : 'inventory';
                        window.fb.onSnapshot(window.fb.doc(db, path, 'master'), (s) => {
                            if(s.exists()) setData(s.data().items);
                        });
                    } else setStatus("Offline");
                });
            }, []);

            const handleUpdate = (id, fieldOrObj, val) => {
                const newData = data.map(cat => ({
                    ...cat, 
                    items: cat.items.map(i => {
                        if(i.id === id) {
                            if(typeof fieldOrObj === 'object') return {...i, ...fieldOrObj};
                            return {...i, [fieldOrObj]: val};
                        }
                        return i;
                    })
                }));
                setData(newData);
                const db = window.fb.getFirestore();
                const path = typeof __app_id !== 'undefined' ? `artifacts/${__app_id}/public/data/inventory` : 'inventory';
                window.fb.setDoc(window.fb.doc(db, path, 'master'), { items: newData }).catch(console.error);
            };

            const handleBackup = () => {
                const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `Mobile_Scan_Backup_${new Date().toLocaleDateString().replace(/\//g,'-')}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleScan = (txt) => {
                let found = null;
                for(const c of data) { const m = c.items.find(i => (i.barcode && i.barcode.includes(txt)) || (i.barcode_case && i.barcode_case === txt)); if(m){found=m; break;} }
                if(found) { 
                    setEditItem(found); 
                    setScanning(false); 
                    playSound('success'); 
                } else {
                    playSound('error');
                    setPendingBarcode(txt);
                    setScanning(false);
                }
            };

            const handleLinkBarcode = (item) => {
                const currentCodes = item.barcode ? item.barcode : "";
                const newCodes = currentCodes ? `${currentCodes},${pendingBarcode}` : pendingBarcode;
                handleUpdate(item.id, 'barcode', newCodes);
                setPendingBarcode(null);
                setEditItem(item); 
                playSound('success');
            };

            const updateItemStickers = (itemId, newStickersArray) => {
                handleUpdate(itemId, 'sticker_ids', newStickersArray);
            };
            
            const saveBottleWeights = (itemId, full, empty) => {
                handleUpdate(itemId, { weight_full: full, weight_empty: empty });
                setCalibratingItem(null);
                playSound('success');
            };

            const filteredData = useMemo(() => {
                const term = search.toLowerCase();
                return data.map(c => ({ ...c, items: c.items.filter(i => i.name.toLowerCase().includes(term)) })).filter(c => c.items.length > 0);
            }, [data, search]);

            if (!auth) return <LoginScreen onLogin={() => setAuth(true)} />;

            return (
                <div className="pb-24 pt-4 px-4 max-w-xl mx-auto">
                    <div className="flex justify-between items-center mb-6 relative">
                        <div className="flex flex-col">
                             <h1 className="font-black text-2xl text-white italic leading-none">SCANNER <span className="text-indigo-500">PRO</span></h1>
                             <span className="text-[10px] text-gray-600 font-mono tracking-widest">v28.0</span>
                        </div>
                        
                        <div className="flex items-center gap-2">
                            <div className="text-xs font-bold text-emerald-400 bg-emerald-900/30 px-2 py-1 rounded border border-emerald-500/30">Cloud ‚òÅÔ∏è</div>
                            <button onClick={() => setShowMenu(!showMenu)} className="bg-gray-800 text-white p-2 rounded-lg border border-gray-700 active:scale-95 transition-all"><Icons.Settings /></button>
                        </div>

                        {showMenu && (
                            <>
                                <div className="menu-backdrop" onClick={() => setShowMenu(false)}></div>
                                <div className="absolute top-14 right-0 bg-[#1D1F23] border border-gray-700 p-2 rounded-xl shadow-2xl z-50 flex flex-col gap-2 w-48 animate-in">
                                    <button onClick={() => { handleBackup(); setShowMenu(false); }} className="flex items-center gap-3 p-3 hover:bg-gray-700 rounded-lg text-white font-bold"><Icons.Save className="text-emerald-400" /> Backup</button>
                                    <button onClick={() => { setShowPurchases(true); setShowMenu(false); }} className="flex items-center gap-3 p-3 hover:bg-gray-700 rounded-lg text-white font-bold"><Icons.Package className="text-emerald-400" /> Purchases</button>
                                    <button onClick={() => { setShowPremium(true); setShowMenu(false); }} className="flex items-center gap-3 p-3 hover:bg-gray-700 rounded-lg text-white font-bold"><Icons.Star className="text-yellow-400" /> Bottle Control</button>
                                    <button onClick={() => { setShowCheck(true); setShowMenu(false); }} className="flex items-center gap-3 p-3 hover:bg-gray-700 rounded-lg text-white font-bold"><Icons.List className="text-white" /> Check List</button>
                                </div>
                            </>
                        )}
                    </div>

                    <button onClick={() => setShowLoc(true)} className="w-full bg-gray-900 border border-gray-700 p-4 rounded-2xl flex items-center justify-between mb-4 group active:scale-95 transition-all">
                        <div className="flex items-center gap-3">
                            <div className="bg-indigo-600 p-2 rounded-lg text-white"><Icons.MapPin /></div>
                            <div className="text-left">
                                <div className="text-xs text-gray-500 uppercase font-bold tracking-wider">Current Zone</div>
                                <div className="text-white font-bold text-lg leading-none">{ZONES_CONFIG[loc] ? (ZONES_CONFIG[loc].find(z=>z.id===subZone)?.label || 'Select Zone') : loc === 'purchases' ? 'Purchases' : 'Main Area'}</div>
                            </div>
                        </div>
                        <Icons.ChevronDown className="text-gray-500"/>
                    </button>

                    <div className="relative mb-6">
                        <Icons.Search className="absolute left-4 top-3.5 text-gray-500" />
                        <input type="text" placeholder="Search item manually..." className="w-full bg-black border border-gray-800 rounded-xl py-3 pl-12 pr-4 text-white focus:border-indigo-500 outline-none" value={search} onChange={e=>setSearch(e.target.value)} />
                    </div>

                    {filteredData.map(cat => (
                        <div key={cat.category} className="mb-4">
                            <h3 className="text-indigo-400 font-bold text-xs uppercase mb-2 ml-2">{cat.category}</h3>
                            <div className="bg-gray-900/50 rounded-2xl overflow-hidden border border-gray-800/50">
                                {cat.items.map(item => {
                                    const qty = parseFloat(item[subZone || loc]) || 0;
                                    return (
                                        <div key={item.id} onClick={() => setEditItem(item)} className="p-4 border-b border-gray-800 last:border-0 flex justify-between items-center active:bg-gray-800 transition-colors cursor-pointer">
                                            <div className="font-medium text-white">{item.name}</div>
                                            {qty > 0 && <div className="bg-indigo-600 text-white font-mono font-bold px-3 py-1 rounded-lg">{qty}</div>}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    ))}

                    <button onClick={() => setScanning(true)} className="fixed bottom-6 right-6 h-16 w-16 bg-indigo-500 hover:bg-indigo-400 text-white rounded-full shadow-2xl flex items-center justify-center border-2 border-white z-30 active:scale-90 transition-transform">
                        <Icons.Scan />
                    </button>

                    {pendingBarcode && (
                        <LinkModal 
                            barcode={pendingBarcode} 
                            data={data} 
                            onLink={handleLinkBarcode} 
                            onClose={() => setPendingBarcode(null)} 
                        />
                    )}

                    {showPremium && <PremiumControlModal onClose={() => setShowPremium(false)} data={data} onUpdateStickers={updateItemStickers} />}
                    {showPurchases && <PurchasesLogModal onClose={() => setShowPurchases(false)} data={data} />}
                    {showCheck && <ReviewModal onClose={() => setShowCheck(false)} data={data} onUpdate={handleUpdate} />}
                    {showLoc && <LocationModal onClose={() => setShowLoc(false)} onSelect={(l, s) => { setLoc(l); setSubZone(s); setShowLoc(false); }} />}
                    {scanning && <ScannerModal onScan={handleScan} onClose={() => setScanning(false)} />}
                    
                    {calibratingItem && <BottleCalibrationModal item={calibratingItem} onClose={()=>setCalibratingItem(null)} onSave={saveBottleWeights} />}

                    {editItem && (
                        <QuickEditModal 
                            item={editItem} 
                            initialLocation={loc} 
                            initialSubZone={subZone} 
                            onClose={() => setEditItem(null)} 
                            onOpenCalibration={setCalibratingItem}
                            onContinue={() => {
                                setEditItem(null);
                                setTimeout(() => setScanning(true), 300); 
                            }}
                            onUpdate={handleUpdate} 
                        />
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
